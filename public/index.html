<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Glasses Order Tools</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">
  <div class="max-w-6xl mx-auto px-4 py-10">
    <header class="mb-8">
      <h1 class="text-3xl font-semibold tracking-tight">Glasses Order Tools</h1>
      <p class="text-slate-600 mt-2">Aggregate orders into a single-row CSV and generate 5×4cm PDF labels.</p>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Module A: Aggregate CSV -->
      <section class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
        <div class="flex items-start justify-between gap-3">
          <div>
            <h2 class="text-xl font-semibold">Export Aggregated CSV</h2>
            <p class="text-slate-600 text-sm mt-1">Upload raw order-line CSV to export one-row-per-order CSV.</p>
          </div>
          <span class="text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-700">Module A</span>
        </div>

        <div class="mt-5 space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700">Order CSV</label>
            <input id="aggFile" type="file" accept=".csv" class="mt-2 block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-slate-900 file:text-white hover:file:bg-slate-800" />
          </div>

          <div class="flex flex-wrap items-center gap-3">
            <button id="aggBtn" class="inline-flex items-center justify-center rounded-lg bg-slate-900 px-4 py-2 text-sm font-medium text-white hover:bg-slate-800">Generate Aggregated CSV</button>
            <button id="aggPing" class="inline-flex items-center justify-center rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-700 hover:bg-slate-50">Test /health</button>
          </div>

          <div id="aggStatus" class="text-sm text-slate-600"></div>
          <div id="aggError" class="hidden text-sm text-red-600 whitespace-pre-wrap"></div>
        </div>
      </section>

      <!-- Module B: PDF Labels -->
      <section class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
        <div class="flex items-start justify-between gap-3">
          <div>
            <h2 class="text-xl font-semibold">Generate PDF Labels</h2>
            <p class="text-slate-600 text-sm mt-1">Upload raw or aggregated CSV and generate 5×4cm labels.</p>
          </div>
          <span class="text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-700">Module B</span>
        </div>

        <div class="mt-5 space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700">CSV File</label>
            <input id="pdfFile" type="file" accept=".csv" class="mt-2 block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-slate-900 file:text-white hover:file:bg-slate-800" />
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
            <div>
              <label class="block text-sm font-medium text-slate-700">Mode</label>
              <select id="pdfMode" class="mt-2 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm">
                <option value="bundle" selected>Bundle (per bundle)</option>
                <option value="order">Order (per order)</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700">Batch Size</label>
              <select id="pdfBatch" class="mt-2 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm">
                <option value="100">100</option>
                <option value="200" selected>200</option>
                <option value="300">300</option>
              </select>
            </div>
            <div class="flex items-end">
              <button id="pdfBtn" class="w-full inline-flex items-center justify-center rounded-lg bg-slate-900 px-4 py-2 text-sm font-medium text-white hover:bg-slate-800">Generate PDF Labels</button>
            </div>
          </div>

          <div id="pdfStatus" class="text-sm text-slate-600"></div>
          <div id="pdfError" class="hidden text-sm text-red-600 whitespace-pre-wrap"></div>
        </div>
      </section>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script>
    const aggFile = document.getElementById('aggFile');
    const aggBtn = document.getElementById('aggBtn');
    const aggPing = document.getElementById('aggPing');
    const aggStatus = document.getElementById('aggStatus');
    const aggError = document.getElementById('aggError');

    const pdfFile = document.getElementById('pdfFile');
    const pdfMode = document.getElementById('pdfMode');
    const pdfBatch = document.getElementById('pdfBatch');
    const pdfBtn = document.getElementById('pdfBtn');
    const pdfStatus = document.getElementById('pdfStatus');
    const pdfError = document.getElementById('pdfError');

    function setStatus(el, msg) {
      el.textContent = msg || '';
    }

    function setError(el, msg) {
      if (!msg) {
        el.classList.add('hidden');
        el.textContent = '';
        return;
      }
      el.classList.remove('hidden');
      el.textContent = msg;
    }

    function downloadBlob(blob, filename) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function parseTotalFromError(text) {
      const m = String(text || '').match(/Too many labels \((\d+)\)/i);
      return m ? Number(m[1]) : null;
    }

    function makeFormData(file) {
      const fd = new FormData();
      fd.append('file', file);
      return fd;
    }

    // Module A: Aggregate
    aggPing.addEventListener('click', async () => {
      setError(aggError, '');
      setStatus(aggStatus, 'Checking /health...');
      try {
        const res = await fetch('/health');
        if (!res.ok) throw new Error('health not ok');
        const t = await res.text();
        setStatus(aggStatus, `OK: ${t}`);
      } catch (e) {
        setStatus(aggStatus, '');
        setError(aggError, String(e));
      }
    });

    aggBtn.addEventListener('click', async () => {
      setError(aggError, '');
      const file = aggFile.files?.[0];
      if (!file) {
        setStatus(aggStatus, '');
        setError(aggError, 'Please choose a CSV file.');
        return;
      }
      setStatus(aggStatus, 'Generating aggregated CSV...');
      try {
        const res = await fetch('/api/aggregate', { method: 'POST', body: makeFormData(file) });
        if (!res.ok) {
          const text = await res.text();
          throw new Error(`HTTP ${res.status}\n\n${text}`);
        }
        const blob = await res.blob();
        downloadBlob(blob, 'orders_one_row.csv');
        setStatus(aggStatus, 'Done. Download started.');
      } catch (e) {
        setStatus(aggStatus, '');
        setError(aggError, String(e));
      }
    });

    // Module B: PDF Labels
    pdfBtn.addEventListener('click', async () => {
      setError(pdfError, '');
      const file = pdfFile.files?.[0];
      if (!file) {
        setStatus(pdfStatus, '');
        setError(pdfError, 'Please choose a CSV file.');
        return;
      }

      const mode = pdfMode.value;
      const batchSize = Number(pdfBatch.value) || 200;

      setStatus(pdfStatus, 'Generating PDF...');
      try {
        // Try single request first
        const res = await fetch(`/api/labels?mode=${encodeURIComponent(mode)}`, { method: 'POST', body: makeFormData(file) });
        if (res.ok) {
          const blob = await res.blob();
          downloadBlob(blob, 'labels_5x4cm.pdf');
          setStatus(pdfStatus, 'Done. Download started.');
          return;
        }

        const errText = await res.text();
        const total = parseTotalFromError(errText);
        if (!total) {
          throw new Error(`HTTP ${res.status}\n\n${errText}`);
        }

        if (!window.PDFLib || !window.PDFLib.PDFDocument) {
          throw new Error('pdf-lib is not loaded.');
        }

        const { PDFDocument } = window.PDFLib;
        const merged = await PDFDocument.create();
        let done = 0;

        for (let start = 0; start < total; start += batchSize) {
          const limit = Math.min(batchSize, total - start);
          setStatus(pdfStatus, `Generating ${Math.min(start + limit, total)}/${total}...`);
          const batchRes = await fetch(`/api/labels?mode=${encodeURIComponent(mode)}&start=${start}&limit=${limit}`, { method: 'POST', body: makeFormData(file) });
          if (!batchRes.ok) {
            const t = await batchRes.text();
            throw new Error(`Batch failed start=${start} limit=${limit}\nHTTP ${batchRes.status}\n\n${t}`);
          }
          const ab = await batchRes.arrayBuffer();
          const src = await PDFDocument.load(ab);
          const pages = await merged.copyPages(src, src.getPageIndices());
          pages.forEach((p) => merged.addPage(p));
          done = Math.min(start + limit, total);
          setStatus(pdfStatus, `Merging ${done}/${total}...`);
        }

        setStatus(pdfStatus, 'Finalizing PDF...');
        const mergedBytes = await merged.save();
        const mergedBlob = new Blob([mergedBytes], { type: 'application/pdf' });
        downloadBlob(mergedBlob, 'labels_5x4cm.pdf');
        setStatus(pdfStatus, 'Done. Download started.');
      } catch (e) {
        setStatus(pdfStatus, '');
        setError(pdfError, String(e));
      }
    });
  </script>
</body>
</html>
